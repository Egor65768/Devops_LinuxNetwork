## Part 1. Инструмент ipcalc

1.1 Сети и маски  

1) Адрес сети 192.167.38.54/13. Выполняем команду ipcalc 192.167.38.54/13 и получаем 192.160.0.0

![linux](src/image/image05.png)  

2) Маска 255.255.255.0 в префиксной форме /24, в двоичной 11111111.11111111.11111111.00000000  
   Маска /15 в обычной 255.254.0.0, в двоичной 11111111.11111110.00000000.00000000  
   Маска 11111111.11111111.11111111.11110000 в префиксной /28 в обычной 255.255.255.240  

3) Минимальный и максимальный хост в сети 12.167.38.4  
   При маске /8 HostMin:   12.0.0.1 HostMax:   12.255.255.254  
   При маске 11111111.11111111.00000000.00000000 (это эквивалентно /16) HostMin:   12.167.0.1  HostMax:   12.167.255.254  
   При маске 255.255.254.0 (это эквивалентно /23) HostMin:   12.167.38.1 HostMax:   12.167.39.254 
   При маске /4 HostMin:   0.0.0.1  HostMax:   15.255.255.254  
   Хостом в компьютерных сетях называют любое устройство, подключенное к сети и способное выполнять функции клиента или сервера.  

1.2. localhost

194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1  
Под localhost зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254). К приложению можно обратиться если оно работает на следующих ip адрессах 127.0.0.2, 127.1.0.1

Проверим:  

![linux](src/image/image06.png)  

![linux](src/image/image07.png)  

Loopback присутствует значит все верно 

1.3. Диапазоны и сегменты сетей  
1) Под частные сети отведены следующие диапазоны  
Класс А: 10.0.0.0 – 10.255.255.255  
Класс Б: 172.16.0.0 – 172.31.255.255  
Класс С: 192.168.0.0 – 192.168.255.255    
Частные: 10.0.0.45, 192.168.4.2,172.20.250.4, 172.16.255.255, 10.10.10.10
Публичные:134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1

2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
HostMin:   10.10.0.1  HostMax:   10.10.63.254 
Ответ: 10.10.0.2, 10.10.10.10,10.10.1.255    
Шлюзом называют устройство, которое соединяет две или более сети и обеспечивает маршрутизацию данных между ними. Шлюзом может быть маршрутизатор, коммутатор или другое устройство, которое выполняет функции маршрутизации. 


## Part 2. Статическая маршрутизация между двумя машинами  

Cуществующие сетевые интерфейсы  

![linux](src/image/image1.jpeg)  

Так как нам надо описать сетевой интерфейс,внутренней сети виртуалки, то выключаем машины и в настройках virtualbox добавляем адаптер(выполняем это для машины 1 и 2) и запускаем машину заново

![linux](src/image/image5.jpeg)

Задача адресов и маскок:  
Добавляем сетевой интерфейс enp0s8 в обе виртуальные машины и описываем его адресс и шлюз

![linux](src/image/image2.jpeg)

Команда для перезапуска сервиса сети  

![linux](src/image/image3.jpeg)

![linux](src/image/image4.jpeg)

Добавим статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add и пропингуем соединение между машинами  

Для ws1

![linux](src/image/image6.jpeg)

Для ws2 

![linux](src/image/image7.jpeg)

Перезапущу машины через команды sudo reboot

И внесу изменения в файл etc/netplan/00-installer-config.yaml. на обоих машинах

"-to" указывает на адрес назначения, к которому применяется этот маршрут, а "via" указывает на IP-адрес шлюза, через который должны проходить пакеты для достижения адреса назначения.

![linux](src/image/image8.jpeg)

перезапустим сервис сети и пропингуем

![linux](src/image/image9.jpeg)

## Part 3. Утилита iperf3  
1) 8 Mbps(мегабиты) в MB/s(мегабайты) 8 Mbps = 1 MB/s  
100 MB/s(мегабайт) в Kbps(килобит) 100 MB/s = 800000 Kbps  
1 Gbps(гигабит) в Mbps(мегабит)  1 Gbps = 1000 Mbps

2) Измерь скорость соединения между ws1 и ws2  
На машине ws1 мы запустили iperf3 в режиме сервера (-s) и будет использовать мегабиты в качестве единиц измерения (-f m). На машине ws2 мы запускаем iperf3 в качестве клиента, указав IP-адресс

![linux](src/image/image10.jpeg)

## Part 4. Сетевой экран

1) Создай файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:  

![linux](src/image/image11.jpeg)  

![linux](src/image/image12.jpeg)    

В средних строчках мы разрешаем доступ к портам 22 и 80     
Для ws1 вначале идет запрещающее правило.Правило запрещает отправку ICMP-пакетов типа 0 (echo reply) из хоста, к которому применено правило.Разрешающее правило идет в конце. На машине ws2 разрешающее и запрещающее правило идет наоборот.  
Запускаем файлы на обеих машинах 

![linux](src/image/image13.jpeg)  

![linux](src/image/image14.jpeg)  

Разница между стратегиями заключается в том что на ws1 вначале пишется запрещающее правило, а затем разрешающее, а на ws2 наоборот.Применяется только первое подходящее правило, а остальные игнорируются. Таким образом, на первой машине применяется запрещающее правил, а на второй применяется разрешающее правило.  

2) Утилита nmap  

![linux](src/image/image15.jpeg)  

Машина ws1 не пингуется, мы проверяем через nmap,которая выводит Host is up

## Part 5. Статическая маршрутизация сети

Подним пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

### 5.1. Настройка адресов машин  

ws11

![linux](src/image/image16.jpeg)  

ws21

![linux](src/image/image17.jpeg)  

ws22

![linux](src/image/image18.jpeg)  

r1

![linux](src/image/image19.jpeg) 

r2

![linux](src/image/image20.jpeg)  

Командой ip -4 проверим что адресса машин заданы верно. Так же пропингуем ws22 с ws21 и r1 с ws11

![linux](src/image/image21.jpeg)  

![linux](src/image/image22.jpeg)  

![linux](src/image/image23.jpeg)  

![linux](src/image/image24.jpeg)  

![linux](src/image/image25.jpeg)  

### 5.2. Включение переадресации IP-адресов. 

Для включения переадресации IP, выполни команду на роутерах:
sysctl -w net.ipv4.ip_forward=1
При таком подходе переадресация не будет работать после перезагрузки системы.

![linux](src/image/image26.jpeg)

![linux](src/image/image27.jpeg)

Откроем файл /etc/sysctl.conf и добавь в него следующую строку:
net.ipv4.ip_forward = 1
При использовании этого подхода, IP-переадресация включена на постоянной основе.

![linux](src/image/image28.jpeg)

![linux](src/image/image29.jpeg)

### 5.3. Установка маршрута по-умолчанию
Настройка маршрута по-умолчанию (шлюз) для рабочих станций.  

![linux](src/image/image30.jpeg)

В ws11 добавляем маршрут по умолчанию r1  

![linux](src/image/image31.jpeg)  

В ws21 добавляем машрут по умолчанию r2  

![linux](src/image/image32.jpeg)

В ws22 добавляем машрут по умолчанию r2 

![linux](src/image/image33.jpeg)
![linux](src/image/image34.jpeg)

В r1 добавляем маршрут до r2, аналогично в r2 добавляем маршрут до r1  

**- to: default via: xxx.xxx.xxx.xxx**Этот маршрут указывает на использование шлюза (gateway) с IP-адресом xxx.xxx.xxx.xxx как маршрута по умолчанию для всех пакетов, которые не имеют специфического маршрута.

Вызовим ip r и покажим, что добавился маршрут в таблицу маршрутизации

![linux](src/image/image35.jpeg)

![linux](src/image/image36.jpeg)

![linux](src/image/image37.jpeg)

![linux](src/image/image38.jpeg)

![linux](src/image/image39.jpeg)

Пропингуем с ws11 роутер r2 и покажи на r2, что пинг доходит.

![linux](src/image/image40.jpeg)

![linux](src/image/image41.jpeg)

### 5.4. Добавление статических маршрутов  

Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:

![linux](src/image/image42.jpeg)

![linux](src/image/image43.jpeg)

Вызови ip r и покажи таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:

![linux](src/image/image44.jpeg)

![linux](src/image/image45.jpeg)

Запусти команды на ws11:
ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0

![linux](src/image/image46.jpeg)


Почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию?  

Маршрут по умолчанию обычно используется, когда компьютер не имеет явно настроенных маршрутов для конкретного пункта назначения. Так для сети 10.10.0.0 было создано правило то используется оно, а не маршрут по умолчанию

### 5.5. Построение списка маршрутизаторов

вызов и вывод traceroute на ws11

![linux](src/image/image47.jpeg)

вызов и вывод tcpdump для enp0s9 на r1

![linux](src/image/image48.jpeg)  

Информация в сети передается в виде пакетов.Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

### 5.6. Использование протокола ICMP при маршрутизации

Запустим на r1 перехват сетевого трафика, проходящего через enp0s8 с помощью команды:  
tcpdump -n -i eth0 icmp  
![linux](src/image/image49.jpeg)  
Пропингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:    
![linux](src/image/image50.jpeg)  

## Part 6. Динамическая настройка IP с помощью DHCP  
DHCP (Dynamic Host Configuration Protocol) - это протокол, который используется для автоматической настройки IP-адресов и других сетевых параметров устройствам в сети. Служба DHCP предоставляет устройствам IP-адрес, шлюз по умолчанию, DNS-серверы и другие настройки, позволяя им быстро и автоматически подключаться к сети без необходимости ручной настройки.  

Для r2 настрой в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:  

1) Укажим адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.  

![linux](src/image/image51.jpeg)  

Это пример конфигурации DHCP сервера для двух подсетей (subnets).
1. Первая подсеть:  
- Сеть: 10.100.0.0  
- Маска подсети (netmask): 255.255.0.0  
В данной конфигурации указывается, что DHCP сервер будет работать с подсетью 10.100.0.0 и использовать маску подсети 255.255.0.0. Это означает, что данная подсеть включает в себя все IP-адреса от 10.100.0.0 до 10.100.255.255.
2. Вторая подсеть:  
- Сеть: 10.20.0.0  
- Маска подсети: 255.255.255.192  
- Диапазон IP-адресов для выделения DHCP сервером: от 10.20.0.2 до 10.20.0.50  
- Адрес шлюза (routers): 10.20.0.1  
- DNS-сервер (domain-name-servers): 10.20.0.1  

2) В файле resolv.conf пропишим nameserver 8.8.8.8.

![linux](src/image/image52.jpeg)  

Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузим при помощи reboot и через ip a покажим, что она получила адрес. Также пропингуй ws22 с ws21.  
![linux](src/image/image53.jpeg)  
![linux](src/image/image54.jpeg)
![linux](src/image/image55.jpeg)   
Укажим MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true  
![linux](src/image/image56.jpeg)  
MAC-адрес (MAC address) – это уникальный идентификатор, присвоенный сетевому адаптеру или другому сетевому устройству на физическом уровне сети. MAC-адрес используется для идентификации устройства в локальной сети (LAN) и обеспечивает уникальность каждого устройства в сети.  

Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). 

![linux](src/image/image57.jpeg)


1. Определен хост с именем "ws11", который имеет MAC-адрес "10:10:10:10:10:BA" и фиксированный IP-адрес "10.10.0.10".  
2. Первая подсеть:  
- Сеть: 10.100.0.0  
- Маска подсети (netmask): 255.255.0.0  
В данной конфигурации указывается, что DHCP сервер будет работать с подсетью 10.100.0.0 и использовать маску подсети 255.255.0.0. Это означает, что данная подсеть включает в себя все IP-адреса от 10.100.0.0 до 10.100.255.255.
3. Вторая подсеть:  
- Сеть: 10.10.0.0  
- Маска подсети: 255.255.192.0 
- Диапазон IP-адресов для выделения DHCP сервером: от 10.10.0.2 до 10.10.63.254  
- Адрес шлюза (routers): 10.10.0.1  
- DNS-сервер (domain-name-servers): 10.10.0.1  

Аналогично в файле resolv.conf пропишим nameserver 8.8.8.8.

![linux](src/image/image58.jpeg)  

перезагружаем службу DHCP  

![linux](src/image/image59.jpeg)  

перезагружаем ws11 и вызываем ip a

![linux](src/image/image60.jpeg)


Запроси с ws21 обновление ip адреса

ip WS21 до обновления

![linux](src/image/image61.jpeg)  

ip WS21 после обновления

![linux](src/image/image62.jpeg)  

## Part 7. NAT

В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным:  

![linux](src/image/image63.jpeg) 

![linux](src/image/image635.jpeg) 

Запустим веб-сервер Apache командой service apache2 start на ws22 и r1:  

![linux](src/image/image64.jpeg) 

![linux](src/image/image645.jpeg) 

Добавим в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:  

1) Удаление правил в таблице filter - iptables -F  


2) Удаление правил в таблице "NAT" - iptables -F -t nat  


3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP  

![linux](src/image/image65.jpeg) 

Запустим файл также, как в Части 4  

![linux](src/image/image66.jpeg)  

Проверь соединение между ws22 и r1 командой ping (При запуске файла с этими правилами, ws22 не должна «пинговаться» с r1)  

![linux](src/image/image67.jpeg) 

4) Теперь добавим разрешение маршрутизации всех пакетов протокола ICMP  

![linux](src/image/image68.jpeg)

![linux](src/image/image69.jpeg)

Проверим соединение между ws22 и r1 командой ping

![linux](src/image/image70.jpeg)

5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)  

SNAT - это технология сетевого адресного перевода, которая используется для изменения IP-адреса источника пакета в сети. SNAT применяется на маршрутизаторах или файрволлах, чтобы изменить исходный IP-адрес пакета перед его отправкой на другой сегмент сети или во внешнюю сеть.  
Цепочка POSTROUTING - это одна из цепочек в таблице маршрутизации iptables в Linux, которая применяется к пакетам после того, как они прошли обработку маршрутизации и перед отправкой из хоста.  
 --jump SNAT --to-source 10.100.0.12: указывает, что для пакетов из исходного IP-диапазона будет применяться SNAT (Source NAT), при этом IP-адрес источника будет заменен на 10.100.0.12 перед отправкой пакета на указанный интерфейс.

6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

PREROUTING применяется к пакетам до того, как они проходят процесс маршрутизации. Это означает, что правила в цепочке PREROUTING могут изменять адреса и порты пакетов до того, как они будут переданы дальше по сети.  
 --dport 8080: указывает на порт назначения.  
DNAT - это механизм в iptables, который позволяет изменять адрес назначения пакета при его прохождении через правила между сетями. DNAT используется для перенаправления трафика на другие узлы или порты в сети.  
Lанное правило NAT перенаправляет входящий TCP-трафик на порт 8080 на хосте с интерфейсом enp0s8 на другой IP-адрес (10.20.0.20) и порт 80.

![linux](src/image/image71.jpeg)

Запустим файл также, как в Части 4

![linux](src/image/image72.jpeg)

Перед тестированием отключим сетевой интерфейс NAT

Проверим соединение по TCP для SNAT: для этого с ws22 подключиться к серверу Apache на r1 командой:

![linux](src/image/image73.jpeg)

Показываю что до r1 доходит

![linux](src/image/image735.jpeg)

Проверь соединение по TCP для DNAT: для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)

![linux](src/image/image74.jpeg)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

Запустим на r2 фаервол с правилами из Части 7: 

![linux](src/image/image71.jpeg)

![linux](src/image/image75.jpeg)

Запустим веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf измени строку Listen 80 на Listen localhost:80):

![linux](src/image/image76.jpeg)

![linux](src/image/image77.jpeg)

Воспользуйся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21:

![linux](src/image/image78.jpeg)

Команда ssh -L 7777:localhost:80 10.20.0.20
Эта команда устанавливает локальный TCP forwarding с порта 7777 на локальной машине на порт 80 на удаленной машине с IP-адресом 10.20.0.20 через SSH.

Воспользуйся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11: 

![linux](src/image/image79.jpeg)

Опция -L (local) позволяет перенаправить трафик с локального порта на удаленный порт через SSH-соединение, а опция -R (remote) позволяет перенаправить трафик с удаленного порта на локальный порт через SSH-соединение.Разница между опциями -L и -R заключается в том, в какую сторону происходит перенаправление трафика

Проверка

![linux](src/image/image80.jpeg)

![linux](src/image/image81.jpeg)
